/*flexberryautogenerated="true"*/
using System;
using System.Data;
using System.Configuration;
using System.Collections;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Web.UI.HtmlControls;
using ICSSoft.STORMNET.Business;
using ICSSoft.STORMNET.Business.LINQProvider;
using System.Collections.Generic;
using ICSSoft.STORMNET;
using System.Linq;
using ICSSoft.STORMNET.Web.AjaxControls.Forms;

namespace IIS.Электронный_Магазин
{
    public partial class Запрос3 : BasePage
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            var ds = (SQLDataService)DataServiceProvider.DataService;
            var mon = DateTime.Today.AddMonths(-3);
            var q = ds.Query<ПоступлениеТовара>(ПоступлениеТовара.Views.ПоступлениеТовараL).Where(a => a.ДатаПоступления >= mon).OrderBy(o=>o.ДатаПоступления).ToList();
            var mas = q.GroupBy(t => t.Товар);
            foreach (var el in mas)
            {
                bool prov=true,first=true;
                double money = 0;
                foreach (var kl in q)
                {
                    if (kl.Товар.Наименование == el.Key.Наименование)
                    {
                        if(first)
                        {
                            first = false;
                            money = kl.Стоимость;
                            prov = false;
                        }
                        else
                        {
                            if(kl.Стоимость<money)
                            {
                                money = kl.Стоимость;
                                prov = true;
                            }
                            else
                            {
                                prov = false;
                            }
                        }
                    }
                }
                if (prov)
                {
                    Bull.Items.Add(el.Key.Наименование);
                }

            }
        }
    }
}
