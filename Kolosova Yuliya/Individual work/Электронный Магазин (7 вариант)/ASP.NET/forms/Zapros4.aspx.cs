/*flexberryautogenerated="true"*/
using System;
using System.Data;
using System.Configuration;
using System.Collections;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Web.UI.HtmlControls;
using ICSSoft.STORMNET.Business;
using ICSSoft.STORMNET.Business.LINQProvider;
using System.Collections.Generic;
using ICSSoft.STORMNET;
using System.Linq;
using ICSSoft.STORMNET.Web.AjaxControls.Forms;

namespace IIS.Электронный_Магазин
{
    public partial class Запрос4 : BasePage
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            var ds = (SQLDataService)DataServiceProvider.DataService;
            var q = ds.Query<Платёжка>(Платёжка.Views.ПлатёжкаL).ToList().Select(c => new { Details = c.СтрокаИзПлатёжки }).ToList();
            int kol = 0;
            DataTable table = new DataTable();
            table.Columns.AddRange(new DataColumn[2] { new DataColumn("Наименование",typeof(string)), new DataColumn("Количество", typeof(Int32)) });
            var tov = ds.Query<Товар>(Товар.Views.ТоварL);
            foreach (var el in tov)
            {
                kol = 0;
                foreach (var kl in q)
                {
                    for(int i=0; i<kl.Details.Count; i++)
                    {
                        if (kl.Details[i].Товар.Наименование == el.Наименование)
                        {
                            kol += kl.Details[i].Количество;
                        }
                    }
                }
                table.Rows.Add(el.Наименование, kol);
            }
            DataView view = table.DefaultView;
            view.Sort = "Количество DESC";
            table = view.ToTable();
            if (table.Rows.Count>10)
            {
                int del = table.Rows.Count - 10;
                for (int i=0;i<del ;i++)
                    table.Rows.RemoveAt(10);
            }
            GridView1.DataSource = table;
            GridView1.DataBind();
        }
    }
}
