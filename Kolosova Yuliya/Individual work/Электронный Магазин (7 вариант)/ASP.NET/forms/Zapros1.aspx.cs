/*flexberryautogenerated="false"*/
using System;
using System.Data;
using System.Configuration;
using System.Collections;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Web.UI.HtmlControls;
using ICSSoft.STORMNET.Business;
using ICSSoft.STORMNET.Business.LINQProvider;
using System.Collections.Generic;
using ICSSoft.STORMNET;
using System.Linq;
using ICSSoft.STORMNET.Web.AjaxControls.Forms;

namespace IIS.Электронный_Магазин
{
    public partial class Запрос1 : BasePage
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            var ds = (SQLDataService)DataServiceProvider.DataService;
            if ((Session["price1"]!= null)&&(Session["price2"]!= null))
            {
                var pr1 = Convert.ToDouble(Session["price1"]);
                var pr2 = Convert.ToDouble(Session["price2"]);
                var tc1 = new TableCell() { Text = "Наименование товара", BorderWidth = 2, BorderStyle = BorderStyle.Solid};
                var tc2 = new TableCell() { Text = "Цена за еденицу товара", BorderWidth =2, BorderStyle = BorderStyle.Solid};
                var tr = new TableRow();
                tr.Cells.AddRange(new TableCell[2] { tc1, tc2 });
                Table.Rows.Add(tr);
                var q = ds.Query<ПоступлениеТовара>(ПоступлениеТовара.Views.ПоступлениеТовараL).ToList();
                var mas = q.GroupBy(t => t.Товар);
                int ksum = 0;
                double ssum =0;
                foreach (var el in mas)
                {
                    ksum = 0;
                    ssum = 0;
                    foreach (var kl in q)
                    {
                        if (kl.Товар.Наименование == el.Key.Наименование)
                        {
                            ksum += kl.Количество;
                            ssum += kl.Стоимость;
                        }
                    }
                    double cash = ssum/ ksum;
                    if ((pr1<= cash) &&(cash <= pr2))
                    {
                       tc1 = new TableCell() { Text = el.Key.Наименование, BorderWidth = 1, BorderStyle = BorderStyle.Solid, HorizontalAlign = HorizontalAlign.Center };
                       tc2 = new TableCell() { Text = cash.ToString("0.00"), BorderWidth = 1, BorderStyle = BorderStyle.Solid, HorizontalAlign = HorizontalAlign.Center };
                       tr = new TableRow();
                        tr.Cells.AddRange(new TableCell[2] { tc1, tc2 });
                        Table.Rows.Add(tr);
                    }

                }
                    Session["price1"] = null;
                    Session["price2"] = null;
            }


        }

        protected void Butt1_Click(object sender, EventArgs e)
        {
            try
            {
                var price1 = Convert.ToDouble(Start.StringValue);
                var price2 = Convert.ToDouble(End.StringValue);
                Session["price1"] = price1;
                Session.Add("price2", price2);

            }
            catch (Exception)
            {
                Session["price1"] = null;
                Session.Add("price2", null);
            }
            Response.Redirect(Request.Url.ToString());
        }
    }
}
