/*flexberryautogenerated="true"*/
using System;
using System.Data;
using System.Configuration;
using System.Collections;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Web.UI.HtmlControls;
using ICSSoft.STORMNET.Business;
using ICSSoft.STORMNET.Business.LINQProvider;
using System.Linq;
using ICSSoft.STORMNET.Web.AjaxControls.Forms;

namespace IIS.Электронный_Магазин
{
    public partial class Запрос5 : BasePage
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            var ds = (SQLDataService)DataServiceProvider.DataService;
            var mon = DateTime.Today.AddMonths(-6);
            var q = ds.Query<Платёжка>(Платёжка.Views.ПлатёжкаL).Where(a => a.Дата >= mon).ToList().Select(c => new { Details = c.СтрокаИзПлатёжки }).ToList();
            var tov = ds.Query<Товар>(Товар.Views.ТоварL);
            double max = 0, maxx=0;
            string name = "";
            foreach (var t in tov)
            {
                foreach (var kl in q)
                {
                    max = 0;
                    for(int i=0;i<kl.Details.Count;i++)
                        if (kl.Details[i].Товар.Наименование == t.Наименование)
                            max += kl.Details[i].Стоимость;
                }
                if (max > maxx)
                {
                    maxx = max;
                    name = t.Наименование;
                }
            }
            Bull.Items.Add(name + " ("+maxx+" р.)");
        }
    }
}
