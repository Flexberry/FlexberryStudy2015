/*flexberryautogenerated="true"*/
using System;
using System.Data;
using System.Configuration;
using System.Collections;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Web.UI.HtmlControls;
using ICSSoft.STORMNET.Business;
using ICSSoft.STORMNET.Web.Tools.WOLVFeatures;
using ICSSoft.STORMNET.Business.LINQProvider;
using System.Linq;


namespace IIS.Indiv_Bahtin
{
    using ICSSoft.STORMNET;
    using ICSSoft.STORMNET.Web.Controls;
    using ICSSoft.STORMNET.Web.AjaxControls;

    public partial class ЗапросВладельцыПривозящиеНаСклад : System.Web.UI.Page
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            ctrlСклад.MasterViewName = Склад.Views.СкладL.Name;
            ctrlСклад.MasterTypeName = typeof(Склад).AssemblyQualifiedName;
            ctrlСклад.PropertyToShow = "Название";

            if (Session["storagepk"] != null)
            {
                var ds = (SQLDataService)DataServiceProvider.DataService;
                var автомашиныPseudoDetail = new PseudoDetail<Автомашина, Поступление>
                    (Поступление.Views.ПоступлениеE,
                    Information.ExtractPropertyPath<Поступление>(p => p.Автомашина));
                var ВладельцыАвтомашинИзПоступленийНаСклад = ds.Query<Автомашина>(Автомашина.Views.АвтомашинаE)
                    .Where(a => автомашиныPseudoDetail.Any(s => s.Склад.__PrimaryKey.ToString() == ctrlСклад.SelectedMasterPK)).ToList()
                    .Select(c => new { Фамилия = c.ВладелецАвтомашины.Фамилия }).Distinct();
                //var ВладельцыАвтомашин = АвтомашиныИзПоступленийНаСклад.Select(o => o.ВладелецАвтомашины.Фамилия).ToList();

                foreach (var Владелец in ВладельцыАвтомашинИзПоступленийНаСклад)
                {
                    TableRow tr = new TableRow();
                    TableCell tc = new TableCell() { Text = Владелец.Фамилия };
                    tr.Cells.Add(tc);
                    TableВладельцы.Rows.Add(tr);
                }
            }

            //WolvOwners.LimitFunction = LinqToLcs.GetLcs(АвтомашиныИзПоступленийНаСклад.Expression,
            //Автомашина.Views.АвтомашинаE).LimitFunction;
            //WolvOwners.LimitFunction = LinqToLcs.GetLcs(ВладельцыАвтомашин.ToList().AsQueryable().Expression,
            //Человек.Views.ЧеловекE).LimitFunction;                     
        }

        protected void Button_Click(object sender, EventArgs e)
        {
            try
            {
                var storagepk = ctrlСклад.SelectedMasterPK;
                Session["storagepk"] = storagepk;
            }
            catch (Exception)
            {
                Session["storagepk"] = null;
            }            
        }
    }
}
